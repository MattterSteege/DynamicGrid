/**
 * DynamicGrid is a library for rendering data in a grid format with dynamic querying capabilities.
 * Code by Matt ter Steege (Kronk)
 * @license MIT
 */
class DynamicGrid{constructor(e){this.eventEmitter=new EventEmitter,this.keyboardShortcuts=new KeyboardShortcuts,this.engine=new SJQLEngine(e.engine||{},this.eventEmitter),this.engine.plugins=e.plugins??[],this.engine.addPlugin(new stringTypePlugin,!0),this.engine.addPlugin(new numberTypePlugin,!0),this.engine.addPlugin(new booleanTypePlugin,!0),this.engine.addPlugin(new dateTypePlugin,!0),this.engine.connectors=e.connectors||[],this.engine.addConnector(new CSVExportConnector,!0),this.engine.addConnector(new XLSXExportConnector,!0),this.engine.addConnector(new JSONExportConnector,!0),this.engine.addConnector(new XMLExportConnector,!0),this.engine.addConnector(new HTMLExportConnector,!0),this.engine.addConnector(new TXTExportConnector,!0),e.headers&&Object.entries(e.headers).forEach((([e,t])=>{this.engine.headers[e]="string"==typeof t?{type:t,isUnique:!1,isGroupable:!0,isHidden:!1,isEditable:!0}:{type:t.type||e,isUnique:t.isUnique||!1,isGroupable:void 0===t.isGroupable||t.isGroupable,isHidden:t.isHidden||!1,isEditable:void 0===t.isEditable||t.isEditable}})),this.virtualScrolling=e.ui.virtualScrolling??!0,this.rowHeight=e.ui.rowHeight||40,this.visibleRows=e.ui.visibleRows||20,this.ui=new DynamicGridUI(this,e.ui,this.eventEmitter),this.eventEmitter.emit("grid-initialized",{config:e})}importData(e,t){this.engine.importData(e,t),this.engine.createDataIndex(),this.eventEmitter.emit("grid-data-imported",{data:e,config:t})}render(e){this.eventEmitter.emit("ui-render-start",{input:e}),this.ui.render(this.engine.query(e)),this.eventEmitter.emit("ui-render-end",{input:e})}renderRaw(e){this.ui.render(e),this.eventEmitter.emit("ui-raw-rendered",{input:e})}addSelect=(e,t,n)=>this.engine.addSelect(e,t,n);setSelect=(e,t,n)=>this.engine.setSelect(e,t,n);removeSelect=(e,t,n)=>this.engine.removeSelect(e,t,n);setSort=(e,t)=>this.engine.setSort(e,t);removeSort=()=>this.engine.removeSort();setRange=(e,t)=>this.engine.setRange(e,t);removeRange=()=>this.engine.removeRange();setGroup=e=>this.engine.setGroup(e);removeGroup=()=>this.engine.removeGroup();runCurrentQuery=()=>this.engine.runCurrentQuery();exportData=(e,t)=>!t&&e&&e.includes(".")?this.engine.requestExport(e.split(".")[0],e.split(".")[1]):this.engine.requestExport(e,t);get exportableFileFormats(){return this.engine.getExportConnectors()}on=(e,t)=>this.eventEmitter.on(e,t);subscribe=(e,t)=>this.eventEmitter.on(e,t);off=(e,t)=>this.eventEmitter.off(e,t);unsubscribe=(e,t)=>this.eventEmitter.off(e,t)}class DynamicGridUI{constructor(e,t,n){this.dynamicGrid=e,this.containerId=t.containerId,this.eventEmitter=n,this.eventEmitter.emit("ui-initialized",{containerId:this.containerId}),this.keyboardShortcuts=e.keyboardShortcuts,this.engine=e.engine,this.table=null,this.header=null,this.body=null,this.scrollContainer=null,this.config={minColumnWidth:t.minColumnWidth??50,rowHeight:t.rowHeight??40,bufferedRows:t.bufferedRows??5,allowFieldEditing:t.allowFieldEditing??!1,colorScheme:t.colorScheme??"light"},this.virtualScrolling={scrollTop:0,visibleRowsCount:0,startIndex:0,endIndex:0,totalHeight:0,topSpacer:null,bottomSpacer:null},this.#e(this.containerId),this.UIChache=0,this.UICacheRefresh=!1,this.showData=[],this.hiddenColumns=new Set,this.undoStack=[],this.redoStack=[],this.contextMenu=new ContextMenu({width:250,style:{accent:"#3b82f6",backgroundColor:"#ffffff",textColor:"#333333",padding:"4px"},closeOnClick:!0,closeOnOutsideClick:!0})}render(e){if(!e)return;if(0===e.length)return void this.clearContent();this.showData=e;const t=(e=>Array.isArray(firstItem(e)))(this.showData),n=t?Object.keys(firstItem(this.showData)[0]):Object.keys(this.showData[0]),r=t?firstItem(this.showData)[0]:this.showData[0],o=FastHash(n);this.UICacheRefresh=this.UIChache!==o,this.UIChache=o,this.UICacheRefresh&&(this.table=this.#t(n.slice(1),r,t)),this.#n(this.showData,n.slice(1),t),this.#r(),this.eventEmitter.emit("ui-rendered",{...this.showData})}toggleColumn(e){const t="number"==typeof e?e:this.engine.getColumns().indexOf(e.toLowerCase());"collapse"===this.colGroup1.children[t+1].style.visibility?this.#o(t):this.#i(t)}clearContent(){this.table&&(this.bodyTable?.remove(),this.scrollContainer?.remove()),this.showData=[],this.eventEmitter.emit("ui-content-cleared")}#i(e){const t=this.colGroup1.children[e+1],n=this.headerTable.querySelector(`th:nth-child(${e+2})`);t&&(t.style.visibility="collapse",n.style.pointerEvents="none");const r=this.colGroup2.children[e+1];r&&(r.style.visibility="collapse")}#o(e){const t=this.colGroup1.children[e+1],n=this.headerTable.querySelector(`th:nth-child(${e+2})`);t&&(t.style.visibility="visible",n.style.pointerEvents="auto");const r=this.colGroup2.children[e+1];r&&(r.style.visibility="visible")}#e(e){if(this.container=document.querySelector(e),!this.container)throw new GridError(`Container with id "${e}" not found`);this.keyboardShortcuts.addShortcut("ctrl+shift+a","Shortcut to automatically fit the columns to a (almost) perfect fit",(()=>{this.autoFitCellWidth()})),this.eventEmitter.emit("ui-container-initialized",{containerId:e})}#t(){return this.UICacheRefresh?(this.table?.remove(),this.table=document.createElement("div"),this.table.className="table",this.table):this.table}#n(e,t,n){const r=this.table&&this.table.parentNode,o=this.headerTable&&this.headerTable.parentNode,i=this.bodyTable&&this.bodyTable.parentNode;if(r||(this.table=document.createElement("div"),this.table.className="dynamic-grid-table",this.table.dataset.theme=this.config.colorScheme),!o){this.headerTable=document.createElement("table"),this.headerTable.className="dynamic-grid-table-header",this.headerTable.setAttribute("cellspacing","0"),this.headerTable.setAttribute("cellpadding","0");const e=this.#s(t);this.colGroup1=e,this.headerTable.appendChild(e),this.headerTable.appendChild(this.#a(t,n,e)),this.table.appendChild(this.headerTable)}if(i)this.bodyTable.innerHTML="",this.bodyTable.appendChild(this.colGroup2);else{this.scrollContainer=document.createElement("div"),this.scrollContainer.className="dynamic-grid-scroll-container",this.scrollContainer.style.position="relative",this.scrollContainer.style.width="100%",this.bodyTable=document.createElement("table"),this.bodyTable.className="dynamic-grid-table-body",this.bodyTable.setAttribute("cellspacing","0"),this.bodyTable.setAttribute("cellpadding","0");const e=this.#s(t);this.colGroup2=e,this.bodyTable.appendChild(e),this.virtualScrolling.topSpacer=document.createElement("tr"),this.virtualScrolling.topSpacer.style.height="0px",this.virtualScrolling.topSpacer.className="virtual-scroll-spacer top-spacer",this.virtualScrolling.bottomSpacer=document.createElement("tr"),this.virtualScrolling.bottomSpacer.style.height="0px",this.virtualScrolling.bottomSpacer.className="virtual-scroll-spacer bottom-spacer",this.scrollContainer.appendChild(this.bodyTable),this.table.appendChild(this.scrollContainer)}this.body=this.#l(),this.bodyTable.appendChild(this.body),this.container.appendChild(this.table)}#s(e){const t=document.createElement("colgroup"),n=document.createElement("col");n.style.width="30px",t.appendChild(n);var r=0;for(const n in e){if("string"!=typeof e[n])continue;const o=document.createElement("col");r+=e[n].width??100,o.style.width=`${e[n].width??100}px`,o.style.minWidth=`${this.config.minColumnWidth}px`,t.appendChild(o)}return t.style.width=`${r}px`,t}#a(e){const t=document.createElement("thead"),n=document.createElement("tr");n.className="header-row";const r=document.createElement("th");return r.className="header-cell top-left-corner",n.appendChild(r),r.addEventListener("contextmenu",(e=>(e.preventDefault(),e.stopPropagation(),this.contextMenu.clear(),this.contextMenu.searchSelect("Columns to show/hide",this.engine.getColumns().map((e=>({label:e,value:e,checked:!0}))),{onChange:e=>{const t=this.engine.getColumns(),n=t.filter((t=>!e.includes(t)));t.forEach((e=>{n.includes(e)?this.#i(t.indexOf(e)):this.#o(t.indexOf(e))}))}}),this.contextMenu.showAt(100,100)))),e.forEach(((e,t)=>{t++;const r=this.engine.getPlugin(e),o=document.createElement("th");o.className="header-cell",o.style.height=`${this.config.rowHeight}px`,o.style.position="relative";const i=document.createElement("div");i.className="header-cell-content";const s=document.createElement("button");s.className="header-cell-button",s.innerText="▼";const a=document.createElement("span");a.className="header-cell-text",a.innerText=e,i.appendChild(s),i.appendChild(a),o.appendChild(i);const l=document.createElement("div");l.className="header-resize-handle";let c=!1,d=0,u=0;const h=this.colGroup1?.children[t];let p=0;l.addEventListener("mouseenter",(()=>{l.classList.add("hover")})),l.addEventListener("mouseleave",(()=>{c||l.classList.remove("hover")})),l.addEventListener("mousedown",(e=>{c=!0,d=e.clientX,u=h?.offsetWidth||100;const n=e=>{if(!c||!h)return;const t=e.clientX-d;p=Math.max(this.config.minColumnWidth,u+t),p=Math.max(p,this.config.minColumnWidth),h.style.width=`${p}px`},r=()=>{c=!1,l.classList.remove("hover"),this.colGroup2.children[t].style.width=`${p}px`,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)})),o.addEventListener("contextmenu",(t=>{t.preventDefault(),t.stopPropagation(),r.showMore(e,o,this.engine,this)})),o.appendChild(l),n.appendChild(o)})),t.appendChild(n),t}#l(){const e=document.createElement("tbody");return e.appendChild(this.virtualScrolling.topSpacer),e.appendChild(this.virtualScrolling.bottomSpacer),this.body=e,e}#r(){if(!this.table||!this.showData.length)return;const e=this.showData.length;this.virtualScrolling.totalHeight=e*this.config.rowHeight;const t=this.table.clientHeight||400;this.virtualScrolling.visibleRowsCount=Math.ceil(t/this.config.rowHeight);const n=this.virtualScrolling.visibleRowsCount+2*this.config.bufferedRows;this.virtualScrolling.startIndex=0,this.virtualScrolling.endIndex=Math.min(n,e),this.table.addEventListener("scroll",this.#c.bind(this)),this._updateVisibleRows(),this.virtualScrolling.scrollTop>0&&(this.table.scrollTop=this.virtualScrolling.scrollTop)}#c(e){const t=e.target.scrollTop;if(this.virtualScrolling.scrollTop===t&&0!==t)return;const n=Math.floor(t/this.config.rowHeight),r=Math.max(0,n-this.config.bufferedRows),o=Math.min(this.showData.length,n+this.virtualScrolling.visibleRowsCount+this.config.bufferedRows);r===this.virtualScrolling.startIndex&&o===this.virtualScrolling.endIndex||(this.virtualScrolling.startIndex=r,this.virtualScrolling.endIndex=o,this._updateVisibleRows())}_updateVisibleRows(){Array.from(this.body.querySelectorAll("tr:not(.virtual-scroll-spacer)")).forEach((e=>e.remove()));const e=document.createDocumentFragment();for(let t=this.virtualScrolling.startIndex;t<this.virtualScrolling.endIndex;t++){const n=this.#d(t);e.appendChild(n)}this.virtualScrolling.topSpacer.after(e),this.virtualScrolling.topSpacer.style.height=this.virtualScrolling.startIndex*this.config.rowHeight+"px";const t=Math.max(0,(this.showData.length-this.virtualScrolling.endIndex)*this.config.rowHeight);this.virtualScrolling.bottomSpacer.style.height=`${t}px`}#d(e){const t=document.createElement("tr");return t.dataset.index=e,this.getData(e,!1).then((n=>{const r=document.createElement("td");r.className="body-cell",r.style.height=`${this.config.rowHeight}px`,r.innerText=e+1,t.appendChild(r),Object.entries(n).forEach((([e,r])=>{if("internal_id"===e)return;const o=this.engine.getPlugin(e),i=this.engine.headers[e].isEditable?o.renderEditableCell(r,(t=>{this.engine.updateTracker.addEdit({column:e,row:n,previousValue:r,newValue:t}),this.engine.alterData(n.internal_id,e,t),this.eventEmitter.emit("ui-cell-edit",{column:e,row:n,previousValue:r,newValue:t}),i.classList.add("edited")})):o.renderCell(r);i instanceof HTMLTableCellElement?(i.className="body-cell",i.style.height=`${this.config.rowHeight}px`,t.appendChild(i)):console.error("[plugin].renderCell() did not return a td element",{td:i,value:r,key:e,plugin:o})}))})),t}getData(e,t=!0){if(!this.showData||e>=this.showData.length)return Promise.reject(new Error("No data to return (data is empty, or index is out of bounds)"));e=e<0?this.showData.length+e:e;const{internal_id:n,...r}=this.showData[e];return Promise.resolve(t?r:this.showData[e])}#u(){const e=this.engine.getColumns(),t={};return e.forEach((e=>{this.engine.getPlugin(e);const n=this.showData.map((t=>t[e]));t[e]=function(e){const t=Math.max(...e.map((e=>String(e).length)));return Math.max(50,8.75*t)}(n)})),t}#h(e){for(let t=0;t<e.length;t++)this.setWidth(t,e[t])}autoFitCellWidth(){this.#h(Object.values(this.#u()))}setWidth(e,t){this.colGroup1.children[e+1].style.width=`${t}px`,this.colGroup2.children[e+1].style.width=`${t}px`}}class ExportConnector{constructor(){this.name="ExportConnector",this.mimeType="application/octet-stream",this.extension="bin"}export(e,t,n){throw new Error("Export or ExportAsync method not implemented")}exportAsync(e,t,n){throw new Error("ExportAsync or Export method not implemented")}_isMethodOverridden(e){let t=Object.getPrototypeOf(this);for(;t&&t!==ExportConnector.prototype;){if(t.hasOwnProperty(e))return!0;t=Object.getPrototypeOf(t)}return!1}async smartExport(e,t,n){const r=this._isMethodOverridden("export"),o=this._isMethodOverridden("exportAsync");if(r&&o)return this.export(e,t,n);if(r)return this.export(e,t,n);if(o)return await this.exportAsync(e,t,n);throw new Error("No export method implemented in subclass")}}class CSVExportConnector extends ExportConnector{constructor(){super(),this.name="csv",this.mimeType="text/csv",this.extension="csv",this.delimiter=";"}export(e){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty data provided for CSV export");const t=Object.keys(e[0]),n=e.map((e=>t.map((t=>{const n=e[t];return"string"==typeof n&&n.includes(this.delimiter)?`"${n.replace(/"/g,'""')}"`:n})).join(this.delimiter)));return[t.join(this.delimiter),...n].join("\n")}}class XLSXExportConnector extends ExportConnector{constructor(){super(),this.name="xlsx",this.mimeType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",this.extension="xlsx"}loadLibrary(){return window.XLSX?Promise.resolve():(this._libraryPromise||(this._libraryPromise=new Promise(((e,t)=>{if(window.XLSX)return e();const n=document.createElement("script");n.src="https://grid.kronk.tech/xlsx.bundle.js",n.type="application/javascript",n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load XLSX library")),document.head.appendChild(n)}))),this._libraryPromise)}async exportAsync(e,t,n){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty data provided for XLSX export");try{await Promise.race([this.loadLibrary(),new Promise(((e,t)=>setTimeout((()=>t(new Error("XLSX library load timeout"))),5e3)))]);const n=XLSX.utils.book_new(),r=XLSX.utils.json_to_sheet(e),o=Object.keys(t).length;return r["!autofilter"]={ref:`A1:${this.getExcelHeaderLetter(o-2)}1`},r["!cols"]=this.fitToColumn(e),r["!cols"].forEach(((e,t)=>{const n=this.getExcelHeaderLetter(t);r[`${n}1`].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4BACC6"}},alignment:{horizontal:"left",vertical:"top"}}})),XLSX.utils.book_append_sheet(n,r,"Sheet"),XLSX.write(n,{type:"array",bookType:"xlsx"})}catch(e){throw console.error("Error during XLSX export:",e),e}}getExcelHeaderLetter(e){let t="";for(;e>=0;)t=String.fromCharCode(e%26+65)+t,e=Math.floor(e/26)-1;return t}fitToColumn(e,t){const n=[];for(const t in e[0])n.push({wch:Math.max(t.length+3,...e.map((e=>e[t]?.toString()?.length??0)))});return n}}class JSONExportConnector extends ExportConnector{constructor(){super(),this.name="json",this.mimeType="application/json",this.extension="json"}export(e,t,n){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty data provided for JSON export");return JSON.stringify(e,null,2)}}class XMLExportConnector extends ExportConnector{constructor(){super(),this.name="xml",this.mimeType="application/xml",this.extension="xml"}export(e,t,n){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty data provided for XML export");return this.jsonToXML(e)}jsonToXML(e){let t="<root>\n";return e.forEach((e=>{t+="  <item>\n";for(const n in e)t+=`    <${n}>${e[n]}</${n}>\n`;t+="  </item>\n"})),t+="</root>",t}}class HTMLExportConnector extends ExportConnector{constructor(){super(),this.name="html",this.mimeType="text/html",this.extension="html"}export(e,t,n){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty data provided for HTML export");let r="<table>\n";return r+=this.headersToHTML(Object.keys(t)),r+=this.jsonToHTML(e),r+="</table>",r}headersToHTML(e){let t="  <tr>\n";return e.forEach((e=>{t+=`    <th>${e}</th>\n`})),t+="  </tr>\n",t}jsonToHTML(e){let t="";return e.forEach((e=>{t+="  <tr>\n";for(const n in e)t+=`    <td>${e[n]}</td>\n`;t+="  </tr>\n"})),t}}class TXTExportConnector extends ExportConnector{constructor(){super(),this.name="txt",this.mimeType="text/plain",this.extension="txt"}export(e,t,n){if(!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty data provided for TXT export");return e.map((e=>Object.values(e).join("\t"))).join("\n")}}class TypePlugin{static DEFAULT_OPERATORS=["==","!=","in"];constructor(){if(this.constructor===TypePlugin)throw new Error("TypePlugin is abstract and cannot be instantiated directly");this.name=this.constructor.name,this.operators=["==","!=","in"]}validate(e){throw new Error("validate must be implemented by subclass")}parseValue(e){throw new Error("parseValue must be implemented by subclass")}evaluate(e,t,n,r){throw new Error("evaluate must be implemented by subclass")}evaluateCondition(e,t,n){throw new Error("evaluateCondition must be implemented by subclass")}sort(e,t){const{field:n,value:r}=e;return[...t].sort(((e,t)=>{const o=String(e[n]).localeCompare(String(t[n]));return"asc"===r?o:-o}))}checkOperator(e){return this.operators.find((t=>t===e))||!1}getOperatorSymbols(){return[...this.operators]}renderCell(e){const t=document.createElement("td");return t.innerText=String(e),t}renderEditableCell(e,t){const n=document.createElement("td");return n.innerHTML=String(e),n.contentEditable=!0,n.spellcheck=!1,n.addEventListener("focus",(e=>{n.classList.add("editing"),n.setAttribute("data-editing","true"),n.setAttribute("start-value",n.innerText)})),n.addEventListener("focusout",(e=>{n.classList.remove("editing"),n.removeAttribute("data-editing"),n.getAttribute("start-value")!==n.innerText&&t(n.innerText),n.removeAttribute("start-value")})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&(n.blur(),e.preventDefault())})),n}showMore(e,t,n,r){const{x:o,y:i,width:s,height:a}=t.getBoundingClientRect(),l=n.headers[e];return console.log(l,e,o,i),r.contextMenu.clear(),r.contextMenu.button("Sort "+e+" ascending",(()=>{n.setSort(e,"asc"),r.render(n.runCurrentQuery())})).button("Sort "+e+" descending",(()=>{n.setSort(e,"desc"),r.render(n.runCurrentQuery())})).button("Unsort "+e,(()=>{n.setSort(e),r.render(n.runCurrentQuery())})),!l.isUnique&&l.isGroupable&&r.contextMenu.separator().button("Group by "+e,(()=>{n.setGroup(e),r.render(n.runCurrentQuery())})).button("Un-group",(()=>{n.setGroup(),r.render(n.runCurrentQuery())})),r.contextMenu.showAt(o,i+a)}}class booleanTypePlugin extends TypePlugin{constructor(){super(),this.operators=["==","!="]}validate(e){return!0===(e=Boolean(e))||!1===e}parseValue(e){if(!0===e||"true"===e||1===e||"1"===e)return!0;if(!1===e||"false"===e||0===e||"0"===e)return!1;throw new Error("Invalid boolean value: "+e)}evaluate(e,t,n,r){if(console.log(e.field,e.value),e.value=!0===e.value,t){const n=t.get(e.value);return new Set([...r].filter((e=>n.has(e))))}return new Set(n.map(((t,n)=>t[e.field]===e.value?n:null)).filter((e=>null!==e)))}evaluateCondition(e,t,n){return this.parseValue(e)===this.parseValue(n)}sort(e,t){const{field:n,value:r}=e;return t.sort(((e,t)=>"asc"===r?e[n]-t[n]:"desc"===r?t[n]-e[n]:void 0))}renderCell(e){const t=document.createElement("td"),n=document.createElement("input");return n.type="checkbox",n.setAttributeNode(document.createAttribute("disabled")),e&&n.setAttributeNode(document.createAttribute("checked")),n.style.width="-webkit-fill-available",t.appendChild(n),t}renderEditableCell(e,t){const n=document.createElement("td"),r=document.createElement("input");return r.type="checkbox",e&&r.setAttributeNode(document.createAttribute("checked")),r.style.width="-webkit-fill-available",r.name="checkbox",r.addEventListener("change",(e=>{t(r.checked)})),n.appendChild(r),n}showMore(e,t,n,r){const{x:o,y:i,width:s,height:a}=t.getBoundingClientRect();return r.contextMenu.clear(),r.contextMenu.button("Sort "+e+" ascending",(()=>{n.setSort(e,"asc"),r.render(n.runCurrentQuery())})).button("Sort "+e+" descending",(()=>{n.setSort(e,"desc"),r.render(n.runCurrentQuery())})).button("Unsort "+e,(()=>{n.setSort(e),r.render(n.runCurrentQuery())})).separator().button("Only show true",(()=>{n.addSelect(e,"==","true"),n.removeSelect(e,"==","false"),r.render(n.runCurrentQuery())})).button("Only show false",(()=>{n.addSelect(e,"==","false"),n.removeSelect(e,"==","true"),r.render(n.runCurrentQuery())})).button("Show all",(()=>{n.removeSelect(e,"==","true"),n.removeSelect(e,"==","false"),r.render(n.runCurrentQuery())})).separator().button("Group by "+e,(()=>{n.setGroup(e),r.render(n.runCurrentQuery())})).button("Un-group",(()=>{n.setGroup(),r.render(n.runCurrentQuery())})),r.contextMenu.showAt(o,i+a)}}class stringTypePlugin extends TypePlugin{constructor(){super(),this.operators=["%=","=%","*=","!*=","==","!=","in"]}validate(e){return"string"==typeof e}parseValue(e){return null==e?null:String(e)}evaluate(e,t,n,r){if(t&&r&&t.size<=r.size)for(const n of t.keys())this.evaluateCondition(n,e.operator,e.value)||t.get(n).forEach((e=>r.delete(e)));else for(const t of r)this.evaluateCondition(n[t][e.field],e.operator,e.value)||r.delete(t);return r}evaluateCondition(e,t,n){if("in"===t&&(n=JSON.parse(n)),Array.isArray(n)&&n.length>0&&"in"===t)return n.includes(e);switch(t){case"==":return e===n;case"!=":return e!==n;case"%=":return e.startsWith(n);case"=%":return e.endsWith(n);case"*=":return e.includes(n);case"!*=":return!e.includes(n)}return!1}sort(e,t){const{field:n,value:r}=e;return t.sort(((e,t)=>"asc"===r?e[n].localeCompare(t[n]):"desc"===r?t[n].localeCompare(e[n]):void 0))}}class numberTypePlugin extends TypePlugin{constructor(){super(),this.operators=[">","<",">=","<=","==","!=","in","><"]}validate(e){if(null==e)return!1;if("number"==typeof e)return!isNaN(e);const t=String(e).replace(",",".");return!isNaN(Number(t))||t.includes("-")&&t.split("-").every((e=>!isNaN(this.parseValue(e))))}parseValue(e){if(null==e)return null;if("number"==typeof e)return e;if(e.toString().split("-").length>1){const t=e.toString().split("-");return[this.parseValue(t[0]),this.parseValue(t[1])]}return e=e.replace(",","."),Number(e)}evaluate(e,t,n,r){if(t&&r&&t.size<=r.size)for(const n of t.keys())this.evaluateCondition(n,e.operator,e.value)||t.get(n).forEach((e=>r.delete(e)));else for(const t of r)this.evaluateCondition(n[t][e.field],e.operator,e.value)||r.delete(t);return r}evaluateCondition(e,t,n){if("in"===t&&(n=JSON.parse(n)),"in"===t&&Array.isArray(n)&&n.length>0)return n.includes(e);switch(t){case">":return e>n;case"<":return e<n;case">=":return e>=n;case"<=":return e<=n;case"==":return e===n;case"!=":return e!==n;case"><":if(!Array.isArray(n)||2!==n.length)throw new Error("between operator requires two numbers");let t=n[0],r=n[1];if(isNaN(t)||isNaN(r))throw new Error("between operator requires two numbers");return t>r&&([t,r]=[r,t]),e>=t&&e<=r}}renderCell(e){const t=document.createElement("td");if(isNaN(e))return t.innerText="",t;const n=e.toString().split(".");return n[0]=n[0].replace(/\B(?=(\d{3})+(?!\d))/g,"."),t.textContent=n.join(","),t}sort(e,t){const{field:n,value:r}=e;return t.sort(((e,t)=>"asc"===r?e[n]-t[n]:"desc"===r?t[n]-e[n]:void 0))}showMore(e,t,n,r){const{x:o,y:i,width:s,height:a}=t.getBoundingClientRect(),l=n.headers[e],c={van:Number.MIN_SAFE_INTEGER,tot:Number.MAX_SAFE_INTEGER};return r.contextMenu.clear(),r.contextMenu.submenu("Filter "+e,(t=>{var o="==";t.dropdown("Filter "+e,[{label:"Gelijk aan",value:"=="},{label:"Niet gelijk aan",value:"!="},{label:"Groter dan",value:">"},{label:"Groter dan of gelijk aan",value:">="},{label:"Kleiner dan",value:"<"},{label:"Kleiner dan of gelijk aan",value:"<="},{label:"tussen",value:"><"},{label:"blank",value:"== null"},{label:"niet blank",value:"!= null"}],{value:"==",onChange:e=>{o=e},id:"dropdown-id"}).input("Filter",{placeholder:"Filter",onChange:t=>{n.setSelect(e,o,t),r.render(n.runCurrentQuery())},showWhen:{elementId:"dropdown-id",value:["==","!=",">","<",">=","<="]}}).input("Filter",{placeholder:"Van",onChange:t=>{c.van=t||Number.MIN_SAFE_INTEGER,c.tot===Number.MAX_SAFE_INTEGER||c.van>c.tot||(n.setSelect(e,"><",c.van+"-"+c.tot),r.render(n.runCurrentQuery()))},showWhen:{elementId:"dropdown-id",value:["><"]}}).input("Filter",{placeholder:"Tot",onChange:t=>{c.tot=t||Number.MAX_SAFE_INTEGER,c.van===Number.MIN_SAFE_INTEGER||c.tot<=c.van||(n.setSelect(e,"><",c.van+"-"+c.tot),r.render(n.runCurrentQuery()))},showWhen:{elementId:"dropdown-id",value:["><"]}})})),r.contextMenu.button("Sort "+e+" ascending",(()=>{n.setSort(e,"asc"),r.render(n.runCurrentQuery())})).button("Sort "+e+" descending",(()=>{n.setSort(e,"desc"),r.render(n.runCurrentQuery())})).button("Unsort "+e,(()=>{n.setSort(e),r.render(n.runCurrentQuery())})),!l.isUnique&&l.isGroupable&&r.contextMenu.separator().button("Group by "+e,(()=>{n.setGroup(e),r.render(n.runCurrentQuery())})).button("Un-group",(()=>{n.setGroup(),r.render(n.runCurrentQuery())})),r.contextMenu.showAt(o,i+a)}}class dateTypePlugin extends TypePlugin{constructor(){super(),this.operators=["==","!=",">","<",">=","<=","in","><"],this.dateFormat="d-m-yyyy"}validate(e){if(null==e)return!1;if("string"==typeof e)return this.parseValue(e)instanceof Date;if(e instanceof Date)throw new GridError("Date values should be provided as strings in d-m-yyyy format, not as Date objects.");return!1}parseValue(e){if(null==e)return null;if("string"==typeof e){const t=e.split("-");if(3!==t.length)throw new Error("Invalid date format, expected d-m-yyyy");const n=parseInt(t[0],10),r=parseInt(t[1],10),o=parseInt(t[2],10);if(isNaN(n)||isNaN(r)||isNaN(o))throw new Error("Invalid date format, expected d-m-yyyy");return n>=1e3?new Date(n,r-1,o):new Date(o,r-1,n)}throw new Error("Invalid date value: "+e+". Date values should be provided as strings in [d]d-[m]m-yyyy format.")}evaluate(e,t,n,r){if(t&&r&&t.size<=r.size)for(const n of t.keys())this.evaluateCondition(n,e.operator,e.value)||t.get(n).forEach((e=>r.delete(e)));else for(const t of r)this.evaluateCondition(n[t][e.field],e.operator,e.value)||r.delete(t);return r}evaluateCondition(e,t,n){if("in"===t&&(n=JSON.parse(n)),Array.isArray(n)&&n.length>0&&"in"===t)return n.includes(e.toString());const r=this.parseValue(e),o=this.parseValue(n);switch(t){case"==":return r.toString()===o.toString();case"!=":return r.toString()!==o.toString();case">":return r.toDate()>o.toDate();case"<":return r.toDate()<o.toDate();case">=":return r.toDate()>=o.toDate();case"<=":return r.toDate()<=o.toDate();case"><":if(!Array.isArray(o))throw new Error("between operator requires two dates");return r.toDate()>=o[0].toDate()&&r.toDate()<=o[1].toDate()}}renderCell(e){const t=document.createElement("td");return null==e?(t.innerText="",t):(t.textContent=e.toString(),t)}renderEditableCell(e,t){e=this.parseValue(e);const n=document.createElement("td"),r=document.createElement("input");return r.type="date",r.value=e.getFullYear()+"-"+(e.getMonth()+1).toString().padStart(2,"0")+"-"+e.getDate().toString().padStart(2,"0"),r.placeholder=this.dateFormat,r.addEventListener("change",(e=>{try{console.log(e.target.value);const n=this.parseValue(e.target.value);t(n.getDate()+"-"+(n.getMonth()+1)+"-"+n.getFullYear())}catch(e){console.error("Invalid date format:",e)}})),n.appendChild(r),n}}class QueryParser{constructor(e){this.config={useStrictCase:e.useStrictCase||!1,SymbolsToIgnore:e.SymbolsToIgnore||["_","-"]}}static QUERIES={FUZZY:/^search\s+"([^"]+)"$/i,GROUP:/group\s+(.+)/i,RANGE:/range\s+(?:(-?\d+)-(-?\d+)?|(-?\d+))/i,SORT:/sort\s+(.+)\s+(asc|desc)/i,SELECT:/(\S+)\s(\S+)\s(.*)/i};parseQuery(e,t,n){return e.split(/\s+and\s+|\s+&&\s+/i).map((e=>this.parseSubQuery(e.trim(),t,n))).filter((e=>e.queryType))}parseSubQuery(e,t,n){if(!(e=e.endsWith(" and")?e.slice(0,-4):e)||0===e.length)return{};for(const[r,o]of Object.entries(QueryParser.QUERIES)){const i=o.exec(e);if(i)return this.parseMatch(i,r,t,n)||{}}return console.warn("Invalid query: "+e+"\nValid queries are: "+Object.keys(QueryParser.QUERIES).join(", ").toLowerCase()+"\nQuery: "+e),{}}parseMatch(e,t,n,r){if("SELECT"===t){let[t,o,i,s]=e;o=findMatchingIndexKey(Object.keys(r),o,this.config);const a=r[o].type,l=n[a];if(!l)throw new GridError("No plugin found for header ("+a+") for key ("+o+")\nDo you know certain that the name of the key is correct?");let c=o,d=l.checkOperator(i);if(!d)throw new GridError(this.formatOperatorError(i,c+" "+i+" "+s,l));if(!l.validate(s))return;return s=l.parseValue(s),{type:a,field:c,operator:d,value:s,queryType:"SELECT"}}if("SORT"===t){let[t,o,i]=e;const s=r[o].type;if(!n[s])throw new GridError("No plugin found for header ("+s+") for key ("+o+")");return{type:s,field:o,operator:"sort",value:i,queryType:"SORT"}}if("RANGE"===t){let[t,n,r,o]=e;return void 0!==o?(n=0,r=parseInt(o)):(n=parseInt(n),r=void 0===r?1/0:parseInt(r),isNaN(n)&&(n=0)),n=Math.max(0,n-1),{type:"range",lower:n,upper:r,queryType:"RANGE"}}if("GROUP"===t){let[t,n]=e;return{type:"group",field:n,queryType:"GROUP"}}if("FUZZY"===t){const[t,n]=e;return{type:"fuzzy",value:n.toLowerCase(),queryType:"FUZZY"}}return console.warn("Invalid query: "+e+"\nValid queries are: "+Object.keys(QueryParser.QUERIES).join(", ").toLowerCase()),{}}formatOperatorError(e,t,n){return["\n\nInvalid operator:    "+e,"       For query:    "+t,"     options are:    "+n.getOperatorSymbols().join(", "),"\n"].join("\n")}}class SJQLEngine{constructor(e,t){this.data=[],this.headers=[],this.plugins=[],this.connectors=[],this.futureQuery=[],this.QueryParser=new QueryParser(e),this.updateTracker=new EditTracker,this.config={},this.APIConnector=e.APIConnector||null,this.eventEmitter=t,this.currentQueryStr=""}createDataIndex(){this.dataIndexes={},Object.keys(this.headers).forEach((e=>{this.dataIndexes[e]=new Map,this.data.forEach(((t,n)=>{const r=t[e];this.dataIndexes[e].has(r)||this.dataIndexes[e].set(r,new Set),this.dataIndexes[e].get(r).add(n)}))}))}autoDetectHeaders(e){for(const t of Object.keys(e))!0===e[t]||!1===e[t]?this.headers[t]={type:"boolean",isUnique:!1,isHidden:!1,isEditable:!0}:isNaN(e[t])?e[t].match(/^(0?[1-9]|[12][0-9]|3[01])-(0?[1-9]|1[0-2])-(\d{4})$/)?this.headers[t]={type:"date",isUnique:!1,isHidden:!1,isEditable:!0}:this.headers[t]={type:"string",isUnique:!1,isHidden:!1,isEditable:!0}:this.headers[t]={type:"number",isUnique:!1,isHidden:!1,isEditable:!0}}getData(e,t=!1){const n=this.data&&this.data.length>0&&e<this.data.length;if(e=e<0?this.data.length+e:e,t){if(!n)throw new Error("No data to return (data is empty, or index is out of bounds)");const{internal_id:t,...r}=this.data[e];return r}return new Promise(((t,r)=>{if(!n)return r(new Error("No data to return (data is empty, or index is out of bounds)"));const{internal_id:o,...i}=this.data[e];t(i)}))}getColumns(){return this.data&&0!==this.data.length?Object.keys(this.data[0]).filter((e=>"internal_id"!==e)):(console.warn("No data provided, returning empty array"),[])}query(e=""){if(!this.data||0===this.data.length)return console.warn("No data provided, returning empty array"),[];if(!e||""===e)return console.warn("No query provided, returning all data"),this.currentQueryStr="",this.data;const t=this.QueryParser.parseQuery(e,this.plugins,this.headers);return this.#p(t)}#p(e){if(!e||0===e.length)return this.currentQueryStr="",console.warn("No valid query provided, returning all data"),this.data;const t=[];let n=null,r=null,o=null,i=null;for(const s of e)switch(s.queryType){case"SELECT":t.push(s);break;case"SORT":n=s;break;case"RANGE":r=s;break;case"GROUP":o=s;break;case"FUZZY":i=s}this.currentQueryStr="",t.forEach((e=>this.currentQueryStr+=e.field+" "+e.operator+" "+e.value+" and ")),n&&(this.currentQueryStr+="sort "+n.field+" "+n.value+" and "),r&&(this.currentQueryStr+="range "+r.lower+" "+r.upper+" and "),o&&(this.currentQueryStr+="group "+o.field+" and "),i&&(this.currentQueryStr+="search "+i.value+" and "),this.currentQueryStr=this.currentQueryStr.slice(0,-5);let s=new Set(this.data.keys()),a=null;for(const e of t){e.field=findMatchingIndexKey(Object.keys(this.data[0]),e.field,this.config);const t=this.getPlugin(e.type);if(!t)throw new GridError(`No plugin found for header (${e.type}) for key (${e.field})`);s=t.evaluate(e,this.dataIndexes[e.field],this.data,s)}if(r){const e=s.values().next().value,t=r.upper<0?this.data.length+r.upper:Math.max(0,e+r.lower),n=r.upper<0?this.data.length:Math.min(this.data.length-1,e+r.upper-1);s=new Set(Array.from({length:n-t+1},((e,n)=>n+t)))}if(o){const e=findMatchingIndexKey(Object.keys(this.data[0]),o.field,this.config);a={};for(const t of s){const n=this.data[t],r=n[e];(a[r]||=[]).push(n)}return n&&console.warn("Sorting grouped data is not yet supported"),a}if(n){const e=this.data.filter(((e,t)=>s.has(t)));return this.getPlugin(n.type).sort(n,e)}if(i){const e=i.value,t=Object.keys(this.data[0]).filter((e=>"internal_id"!==e));s=new Set([...s].filter((n=>{const r=this.data[n];return t.some((t=>String(r[t]).toLowerCase().includes(e)))})))}return this.data.filter(((e,t)=>s.has(t)))}addSelect(e,t,n){if(!e||!t||void 0===n)return;const r=`${e} ${t} ${n}`;0===this.currentQueryStr.length?this.currentQueryStr=r:this.currentQueryStr+=` and ${r}`}setSelect(e,t,n){this.removeSelect(e),this.addSelect(e,t,n)}removeSelect(e,t,n){if(void 0!==e&&void 0===t&&void 0===n)this.currentQueryStr=this.currentQueryStr.split("and").filter((t=>!t.trim().startsWith(e))).join(" and ");else if(void 0!==e&&void 0!==t&&void 0===n)this.currentQueryStr=this.currentQueryStr.split("and").filter((n=>!n.trim().startsWith(`${e} ${t}`))).join(" and ");else if(void 0!==e&&void 0!==t&&void 0!==n){const r=`${e} ${t} ${n}`;this.currentQueryStr=this.currentQueryStr.split("and").filter((e=>e.trim()!==r)).join(" and ")}}setSort(e,t){if(void 0===e||void 0===t)return void this.removeSort();const n=`sort ${e} ${t}`;this.removeSort(),0===this.currentQueryStr.length?this.currentQueryStr=n:this.currentQueryStr+=` and ${n}`}removeSort(){this.currentQueryStr=this.currentQueryStr.split("and").filter((e=>!e.trim().startsWith("sort"))).join(" and ")}setRange(e,t){if(void 0===e||void 0===t)return void this.removeRange();const n=`range ${e} ${t}`;this.removeRange(),0===this.currentQueryStr.length?this.currentQueryStr=n:this.currentQueryStr+=` and ${n}`}removeRange(){this.currentQueryStr=this.currentQueryStr.split("and").filter((e=>!e.trim().startsWith("range"))).join(" and ")}setGroup(e){if(void 0===e)return void this.removeGroup();const t=`group ${e}`;this.removeGroup(),0===this.currentQueryStr.length?this.currentQueryStr=t:this.currentQueryStr+=` and ${t}`}removeGroup(){this.currentQueryStr=this.currentQueryStr.split("and").filter((e=>!e.trim().startsWith("group"))).join(" and ")}runCurrentQuery(){return grid.eventEmitter.emit("engine-query-update",grid.engine.currentQueryStr),this.query(this.currentQueryStr)}addPlugin(e,t=!1){if(!(e instanceof TypePlugin))throw new GridError("Plugin must extend TypePlugin");const n=this.getPlugin(e.name,!0);t&&n||(n&&!t?(console.warn("Plugin already exists, removing the old plugin"),this.plugins[e.name.replace("TypePlugin","")]=e):this.plugins[e.name.replace("TypePlugin","")]=e)}getPlugin(e,t=!1){if(!e)throw new GridError("Plugin name not provided");if("string"!=typeof e)return!1;var n=this.plugins[e.replace("TypePlugin","")];if(n||(n=this.plugins[this.headers[e]?.type]),!n&&!t)throw new GridError("Plugin not found: "+e);return!(!n&&t)&&n}addConnector(e,t=!1){if(!(e instanceof ExportConnector))throw new GridError("Connector must extend ExportConnector");const n=this.getConnector(e.name,!0);t&&n||(n&&!t?(console.warn("Connector already exists, removing the old Connector"),this.connectors[e.name.replace("ExportConnector","")]=e):this.connectors[e.name.replace("ExportConnector","")]=e)}getConnector(e,t=!1){if(!e)throw new GridError("Connector name not provided");if("string"!=typeof e)return!1;const n=this.connectors[e];if(!n&&!t)throw new GridError("Connector not found: "+e);return!(!n&&t)&&n}importData(e,t){if(this.data&&this.data.length>0)throw new GridError("Data already imported, re-importing data is not (yet) supported");if("json"===t.type)this.#m(e,t);else{if("csv"!==t.type)throw new GridError("Invalid data type");this.#g(e,t)}0===Object.keys(this.headers).length&&(console.warn("No headers provided, auto detecting headers, please provide so the system can you more optimal plugins"),this.autoDetectHeaders(this.data[0]))}alterData(e,t,n){const r=this.data[e][t];this.data&&this.data.length>0&&(this.data[e][t]=n),this.dataIndexes&&this.dataIndexes[t]&&(this.dataIndexes[t].has(r)&&this.dataIndexes[t].get(r).delete(e),this.dataIndexes[t].has(n)||this.dataIndexes[t].set(n,new Set),this.dataIndexes[t].get(n).add(e))}#m(e,t){if("string"!=typeof e&&"object"!=typeof e)throw new GridError("Data must be a string (raw JSON) OR an object (parsed JSON)");if(e="string"==typeof e?JSON.parse(e):e,!Array.isArray(e))throw new GridError("Data must be an array");if(0===e.length)return console.warn("No data provided"),[];this.data=e.map(((e,t)=>{const n={};n.internal_id=t;for(const t of Object.keys(e))n[t]=e[t];return n}))}#g(e,t){const n=e.split("\n"),r=n[0].split(",").map((e=>e.replace(/"/g,"").replace(" ","_").replace("\r","")));this.data=n.slice(1).map(((e,t)=>{const n=e.split(/(?!"[a-zA-z0-9\s.()]*)(?:,|,"|",)(?![a-zA-z0-9\s.()]*")/gim),o={};return o.internal_id=t,r.forEach(((e,t)=>{"string"==typeof n[t]&&(n[t].endsWith('"')?n[t]=n[t].slice(0,-1):n[t]),o[e]=n[t]})),o})).slice(0,-1)}async requestExport(e,t){const n=this.getConnector(t);if(n){try{const t=await n.smartExport(this.data.map((e=>{const t={};return Object.keys(e).forEach((n=>{"internal_id"!==n&&(t[n]=e[n])})),t})),this.headers,e);if(!t)return void console.warn("No data returned for export");const r=new Blob([t],{type:n.mimeType}),o=URL.createObjectURL(r),i=document.createElement("a");i.href=o,i.download=`${e||"export"}.${n.extension}`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}catch(e){return console.error(e.message),alert("Export failed. See console for details."),!1}return!0}console.error("Connector not found: "+t)}getExportConnectors=()=>Object.keys(this.connectors)}class EditTracker{constructor(){this.updates=[]}addEdit(e){this.updates.push(e),this.updates=this.cleanUpdates(this.updates)}cleanUpdates(e){const t=new Map;return e.forEach((e=>{const n=`${e.row.internal_id}_${e.column}`;t.set(n,{...e})})),Array.from(t.values()).filter((e=>e.previousValue!==e.newValue))}clear(){this.updates=[]}}class GridError extends Error{constructor(e){super(e),this.name="GridError",this.stack=""}}function FastHash(e){const t=JSON.stringify(e);let n=0;for(let e=0;e<t.length;e++)n=(n<<5)-n+t.charCodeAt(e),n|=0;return n}function findMatchingIndexKey(e,t,n){const r=e=>{let t=e;if(n.SymbolsToIgnore?.length){const e=new RegExp(`[${n.SymbolsToIgnore.join("").replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}]`,"g");t=t.replace(e,"")}return n.useStrictCase?t:t.toLowerCase()},o=r(t);return e.find((e=>r(e)===o))}function firstItem(e){return!(!e||"object"!=typeof e)&&(Array.isArray(e)?e[0]:e[Object.keys(e)[0]])}async function waitState(){return new Promise((e=>{let t=setInterval((function(){1==o.state&&(clearInterval(t),e(o.state))}),1e3)}))}Array.prototype.remove=function(e){const t=this.indexOf(e);return t>-1&&this.splice(t,1),this},Number.prototype.padLeft=function(e,t){let n=String(this);for(;n.length<e;)n=t+n;return n},Date.prototype.addDays=function(e){var t=new Date(this.valueOf());return t.setDate(t.getDate()+e),t},Date.prototype.addHours=function(e){var t=new Date(this.valueOf());return t.setHours(t.getHours()+e),t},Date.prototype.addMinutes=function(e){var t=new Date(this.valueOf());return t.setMinutes(t.getMinutes()+e),t},Date.prototype.addSeconds=function(e){var t=new Date(this.valueOf());return t.setSeconds(t.getSeconds()+e),t},Date.prototype.addMilliseconds=function(e){var t=new Date(this.valueOf());return t.setMilliseconds(t.getMilliseconds()+e),t};class EventEmitter{constructor(){this.events={}}subscribe(e,t){return this.events[e.toLocaleLowerCase()]||(this.events[e.toLocaleLowerCase()]=[]),this.events[e.toLocaleLowerCase()].push(t),()=>this.unsubscribe(e,t)}on=this.subscribe;unsubscribe(e,t){this.events[e.toLocaleLowerCase()]&&(this.events[e.toLocaleLowerCase()]=this.events[e.toLocaleLowerCase()].filter((e=>e!==t)))}off=this.unsubscribe;emit(e,t){this.events[e.toLocaleLowerCase()]&&this.events[e.toLocaleLowerCase()].forEach((e=>e(t)))}}class KeyboardShortcuts{constructor(){this.shortcuts=new Map,this.listener=this.#y.bind(this),document.addEventListener("keydown",this.listener)}#f(e){return e.toLowerCase().replace(/\s+/g,"")}#y(e){const t=this.#f(`${e.ctrlKey?"ctrl+":""}${e.shiftKey?"shift+":""}${e.altKey?"alt+":""}${e.metaKey?"meta+":""}${e.key}`),n=this.shortcuts.get(t);n&&(e.preventDefault(),n(e))}addShortcut(e,t,n){const r=this.#f(e);this.shortcuts.has(r)?console.warn(`Shortcut '${e}' is already assigned.`):this.shortcuts.set(r,n)}removeShortcut(e){const t=this.#f(e);this.shortcuts.has(t)?this.shortcuts.delete(t):console.warn(`Shortcut '${e}' does not exist.`)}listShortcuts(){return Array.from(this.shortcuts.keys())}clearShortcuts(){this.shortcuts.clear()}destroy(){document.removeEventListener("keydown",this.listener),this.clearShortcuts()}}class ContextMenu{static ITEM_TYPES={BUTTON:"button",SEPARATOR:"separator",SUBMENU:"submenu",INPUT:"input",DROPDOWN:"dropdown",CHECKBOX:"checkbox",RADIO:"radio",SEARCH_SELECT:"search-select"};static CLASSNAMES={BUTTON:"context-menu-button",SUBMENU:"context-menu-submenu",SEPARATOR:"context-menu-separator",MENU:"context-menu",INPUT:"context-menu-input",DROPDOWN:"context-menu-dropdown",CHECKBOX:"context-menu-checkbox",RADIO:"context-menu-radio",CONTAINER:"context-menu-container",SEARCH_SELECT:"context-menu-search-select",ICON:"context-menu-icon",LABEL:"context-menu-label"};constructor(e={}){this.options={width:e.width||200,animation:{enabled:e.animation?.enabled??!0,duration:e.animation?.duration||200,timing:e.animation?.timing||"ease-out"},position:{xOffset:e.position?.xOffset||0,yOffset:e.position?.yOffset||0},icons:e.icons||{submenu:"❯"},style:{backgroundColor:e.style?.backgroundColor||"#ffffff",textColor:e.style?.textColor||"#333333",backgroundHoverColor:e.style?.backgroundHoverColor||"#f0f0f0",border:e.style?.border||"rgba(0, 0, 0, 0.08)",shadow:e.style?.shadow||"0 10px 25px rgba(0, 0, 0, 0.1)",accent:e.style?.accent||"#3b82f6",separator:e.style?.separator||"rgba(0, 0, 0, 0.08)",padding:e.style?.padding||"10px",paddingHorizontal:e.style?.paddingHorizontal||"15px",gap:e.style?.gap||"10px",borderRadius:e.style?.borderRadius||"8px",borderRadiusInput:e.style?.borderRadiusInput||"4px",fontSize:e.style?.fontSize||"14px",transition:e.style?.transition||"0.2s",transitionFast:e.style?.transitionFast||"0.1s",transitionInput:e.style?.transitionInput||"0.2s"},indentLevel:e.indentLevel||0,isRoot:void 0===e.isRoot,closeOnClick:e.closeOnClick,closeOnOutsideClick:e.closeOnOutsideClick},this.items=[],this.id=this.#b(),this.installStyles()}addItem(e,t){const n={id:(t?.id??this.#b())+"",type:e,position:this.items.length,...t};return void 0===n.id&&(n.id=this.#b()),n.type===ContextMenu.ITEM_TYPES.SUBMENU&&(n.submenu.options.indentLevel=(this.options.indentLevel||0)+1),this.#v(n),this.items.push(n),this}button(e,t,n={}){return this.addItem(ContextMenu.ITEM_TYPES.BUTTON,{text:e,action:t,icon:n.icon,ficon:n.ficon,disabled:n.disabled,marked:n.marked,showWhen:n.showWhen,id:n.id})}input(e,t={}){return this.addItem(ContextMenu.ITEM_TYPES.INPUT,{label:e,placeholder:t.placeholder,value:t.value,onChange:t.onChange,showWhen:t.showWhen,id:t.id})}dropdown(e,t,n={}){return this.addItem(ContextMenu.ITEM_TYPES.DROPDOWN,{label:e,options:t,value:n.value,onChange:n.onChange,multiSelect:n.multiSelect,showWhen:n.showWhen,id:n.id})}checkbox(e,t={}){return this.addItem(ContextMenu.ITEM_TYPES.CHECKBOX,{text:e,checked:t.checked||!1,onChange:t.onChange,showWhen:t.showWhen,id:t.id})}radioGroup(e,t,n={}){return t.forEach((t=>{this.addItem(ContextMenu.ITEM_TYPES.RADIO,{label:t.label,value:t.value,name:e,checked:t.checked,onChange:n.onChange,showWhen:n.showWhen,id:n.id})})),this}separator(){return this.addItem(ContextMenu.ITEM_TYPES.SEPARATOR,{})}submenu(e,t,n={}){const r={...this.options,isRoot:!1,indentLevel:(this.options.indentLevel||0)+1,showWhen:n.showWhen,id:n.id},o=new ContextMenu(r);t(o);const i=this.addItem(ContextMenu.ITEM_TYPES.SUBMENU,{text:e,submenu:o,icon:n.icon,ficon:n.ficon,showWhen:n.showWhen,id:n.id}).items;return i[i.length-1].id=o.id,this}searchSelect(e,t,n={}){return this.addItem(ContextMenu.ITEM_TYPES.SEARCH_SELECT,{label:e,options:t,value:n.value,onChange:n.onChange,showWhen:n.showWhen,id:n.id})}showAt(e,t,n=!0){const r=this.#x();return document.getElementById(this.id)&&document.getElementById(this.id).remove(),n&&document.body.appendChild(r),this.#E(r),this.#S(r,{x:e,y:t,position:"fixed"}),this.#C(r),r}destroy(){const e=document.querySelector("body > ."+ContextMenu.CLASSNAMES.MENU);e&&e.remove();const{handleClick:t,handleContextMenu:n,handleMouseOver:r}=this._eventHandlers||{};t&&document.removeEventListener("click",t),n&&document.removeEventListener("contextmenu",n),r&&document.removeEventListener("mouseover",r),this?.clear()}clear(){this.items=[];const e=document.getElementById(this.id);e&&(e.innerHTML="")}#E(e){const t=e=>{const t=e.target;if(t.className===ContextMenu.CLASSNAMES.MENU)return void t.remove();const n=document.getElementById(t.dataset?.submenuId),r=t.matches(":hover"),o=n?.matches(":hover");r||o||n?.remove()};e.addEventListener("click",(e=>{if(!(e.target.classList.contains(ContextMenu.CLASSNAMES.DROPDOWN)||e.target.classList.contains(ContextMenu.CLASSNAMES.INPUT)||e.target.classList.contains(ContextMenu.CLASSNAMES.CHECKBOX)||e.target.classList.contains(ContextMenu.CLASSNAMES.RADIO)||e.target.classList.contains(ContextMenu.CLASSNAMES.SEARCH_SELECT))){if(e.target.classList.contains(ContextMenu.CLASSNAMES.BUTTON)){const t=this.items.find((t=>t.id===e.target.id));t&&(t.action(),this.destroy())}if(!e.target.closest("."+ContextMenu.CLASSNAMES.MENU)){if(!this.options.closeOnOutsideClick)return;this.destroy()}}})),e.addEventListener("mouseover",(e=>{if(e.target.classList.contains(ContextMenu.CLASSNAMES.SUBMENU)){const n=this.items.find((t=>t.id===e.target.dataset.submenuId));if(n){if(e.target.parentElement.querySelector("#"+n.submenu.id))return;const r=n.submenu.#x();n.submenu.#E(r),n.submenu.#S(r,{x:e.target.getBoundingClientRect().right,y:e.target.getBoundingClientRect().top}),r.style.position="absolute",r.style.left=this.options.width+"px",r.style.top=e.target.getBoundingClientRect().top-e.target.parentElement.getBoundingClientRect().top+"px",e.target.parentElement.appendChild(r),r.addEventListener("mouseleave",t),e.target.addEventListener("mouseleave",t)}}})),addEventListener("click",(e=>{e.target.closest("."+ContextMenu.CLASSNAMES.MENU)||this.options.closeOnOutsideClick&&this.destroy()}))}#v(e){const t=Object.values(ContextMenu.ITEM_TYPES);if(!e.type||!t.includes(e.type))throw new Error(`Invalid item type: ${e.type}. Allowed types are: ${t.join(", ")}`);switch(e.type){case ContextMenu.ITEM_TYPES.BUTTON:if(!e.text||"string"!=typeof e.text)throw new Error('Button item must have a "text" property of type string.');if(e.action&&"function"!=typeof e.action)throw new Error("Button item action must be a function.");break;case ContextMenu.ITEM_TYPES.SEPARATOR:break;case ContextMenu.ITEM_TYPES.SUBMENU:if(!(e.submenu&&e.submenu instanceof ContextMenu))throw new Error('Submenu item must have a "submenu" property that is an instance of ContextMenu.');break;case ContextMenu.ITEM_TYPES.INPUT:if(!e.label||"string"!=typeof e.label)throw new Error('Input item must have a "label" property of type string.');break;case ContextMenu.ITEM_TYPES.DROPDOWN:if(!e.label||"string"!=typeof e.label)throw new Error('Dropdown item must have a "label" property of type string.');if(!Array.isArray(e.options)||0===e.options.length)throw new Error('Dropdown item must have a non-empty "options" array.');break;case ContextMenu.ITEM_TYPES.CHECKBOX:if(!e.text||"string"!=typeof e.text)throw new Error('Checkbox item must have a "text" property of type string.');if("boolean"!=typeof e.checked)throw new Error('Checkbox item must have a "checked" property of type boolean.');break;case ContextMenu.ITEM_TYPES.RADIO:if(!e.label||"string"!=typeof e.label)throw new Error('Radio item must have a "label" property of type string.');if(!e.name||"string"!=typeof e.name)throw new Error('Radio item must have a "name" property of type string.');break;case ContextMenu.ITEM_TYPES.SEARCH_SELECT:if(!e.label||"string"!=typeof e.label)throw new Error('SearchSelect item must have a "label" property of type string.');if(!Array.isArray(e.options)||0===e.options.length)throw new Error('SearchSelect item must have a non-empty "options" array.');break;default:throw new Error(`Unhandled item type: ${e.type}`)}}#b(){return"_"+Math.random().toString(36).substring(2,9)}#x(){const e=document.createElement("div");return e.classList.add(ContextMenu.CLASSNAMES.MENU),e.id=this.id,e.setAttribute("role","menu"),e.setAttribute("aria-orientation","vertical"),e.style.width=`${this.options.width}px`,e.dataset.indent=this.options.indentLevel,this.items.forEach((t=>{let n;switch(t.type){case ContextMenu.ITEM_TYPES.BUTTON:n=this.#w(t);break;case ContextMenu.ITEM_TYPES.SEPARATOR:n=this.#T();break;case ContextMenu.ITEM_TYPES.SUBMENU:n=this.#M(t);break;case ContextMenu.ITEM_TYPES.INPUT:n=this.#I(t);break;case ContextMenu.ITEM_TYPES.DROPDOWN:n=this.#k(t);break;case ContextMenu.ITEM_TYPES.CHECKBOX:n=this.#A(t);break;case ContextMenu.ITEM_TYPES.RADIO:n=this.#L(t);break;case ContextMenu.ITEM_TYPES.SEARCH_SELECT:n=this.#N(t);break;default:console.warn(`Unknown item type: ${t.type}`)}n&&e.appendChild(n),setTimeout((()=>{if(t.showWhen){const{elementId:e,value:r}=t.showWhen,o=document.querySelector("#"+e);if(o){const e=()=>{const e=r.includes(o.value);n.style.display=e?"block":"none"};o.addEventListener("input",e),o.addEventListener("change",e),e()}}}),0)})),e}#w(e){const t=document.createElement("button");if(t.classList.add(ContextMenu.CLASSNAMES.BUTTON),t.id=e.id,t.innerText=e.text,t.disabled=e.disabled||!1,t.dataset.marked=e.marked||!1,e.icon){const n=document.createElement("span");n.innerText=e.icon,t.prepend(n)}if(e.ficon){const n=document.createElement("i");n.className=e.ficon,t.append(n)}return t}#T(){const e=document.createElement("div");return e.classList.add(ContextMenu.CLASSNAMES.SEPARATOR),e}#M(e){const t=document.createElement("button");if(t.classList.add(ContextMenu.CLASSNAMES.SUBMENU),t.innerText=e.text,t.setAttribute("aria-haspopup","true"),t.dataset.submenuId=e.id,e.icon){const n=document.createElement("span");n.innerText=e.icon,t.prepend(n)}const n=document.createElement("span");if(n.innerText=this.options.icons.submenu,n.style.marginLeft="auto",t.append(n),e.ficon){const n=document.createElement("i");n.className=e.ficon,t.append(n)}return t}#I(e){const t=document.createElement("div");t.classList.add(ContextMenu.CLASSNAMES.INPUT);const n=document.createElement("input");return n.type=e.type||"text",n.placeholder=e.placeholder||"",n.value=e.value||"",n.oninput=t=>e.onChange?.(t.target.value),n.id=e.id,t.appendChild(n),t}#k(e){const t=document.createElement("select");return t.classList.add(ContextMenu.CLASSNAMES.DROPDOWN),t.id=e.id,e.options.forEach((n=>{const r=document.createElement("option");r.value=n.value,r.textContent=n.label,n.value===e.value&&(r.selected=!0),t.appendChild(r)})),t.onchange=t=>e.onChange?.(t.target.value),t}#A(e){const t=document.createElement("label");t.classList.add(ContextMenu.CLASSNAMES.CHECKBOX);const n=document.createElement("input");n.type="checkbox",n.checked=e.checked||!1,n.onchange=t=>e.onChange?.(t.target.checked),n.id=e.id;const r=document.createElement("span");return r.textContent=e.text,t.appendChild(n),t.appendChild(r),t}#L(e){const t=document.createElement("label");t.classList.add(ContextMenu.CLASSNAMES.RADIO);const n=document.createElement("input");n.type="radio",n.name=e.name,n.value=e.value,n.checked=e.checked||!1,n.onchange=t=>e.onChange?.(t.target.value),n.id=e.id;const r=document.createElement("span");return r.textContent=e.label,t.appendChild(n),t.appendChild(r),t}#N(e){const t=document.createElement("div");t.classList.add(ContextMenu.CLASSNAMES.SEARCH_SELECT),t.id=e.id;const n=document.createElement("input");n.type="text",n.placeholder=e.label||"";const r=document.createElement("div");r.classList.add(ContextMenu.CLASSNAMES.SEARCH_SELECT+"-list");const o=document.createElement("button");return o.textContent="Toggle All",o.onclick=n=>{const o=r.querySelectorAll('input[type="checkbox"]'),i=Array.from(o).every((e=>e.checked));o.forEach((e=>{e.checked=!i}));const s=Array.from(r.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.value));e.onChange?.(s),t.value=s},r.appendChild(o),e.options.forEach((n=>{const o=document.createElement("input");o.type="checkbox",o.value=n.value,o.checked=n.checked||!1,o.onchange=n=>{const o=Array.from(r.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.value));e.onChange?.(o),t.value=o};const i=document.createElement("label");i.textContent=n.label,i.appendChild(o),r.appendChild(i)})),t.appendChild(n),t.appendChild(r),n.oninput=e=>{const t=e.target.value.toLowerCase();r.querySelectorAll("label").forEach((e=>{const n=e.textContent.toLowerCase();e.style.display=n.includes(t)?"block":"none"}))},t}#S(e,t){const{x:n,y:r}=t,{xOffset:o,yOffset:i}=this.options.position;e.style.left=`${n+o||this.options.width}px`,e.style.top=`${r+i}px`,e.style.position="fixed"}#C(e){this.options.animation.enabled&&(e.style.opacity=0,e.style.transform="scale(0.9)",e.style.transition=`opacity ${this.options.animation.duration}ms ${this.options.animation.timing}, \n                             transform ${this.options.animation.duration}ms ${this.options.animation.timing}`,requestAnimationFrame((()=>{e.style.opacity=1,e.style.transform="scale(1)"})))}installStyles(){if(document.getElementById("context-menu-styles"))return;const e=document.createElement("style");e.id="context-menu-styles",e.textContent="\n:root {\n  --context-menu-bg: "+(this.options.style.backgroundColor||"#ffffff")+";\n  --context-menu-text: "+(this.options.style.textColor||"#333333")+";\n  --context-menu-hover-bg: "+(this.options.style.backgroundHoverColor||"#f0f0f0")+";\n  --context-menu-border: "+(this.options.style.border||"rgba(0, 0, 0, 0.08)")+";\n  --context-menu-shadow: "+(this.options.style.shadow||"0 10px 25px rgba(0, 0, 0, 0.1)")+";\n  --context-menu-accent: "+(this.options.style.accent||"#3b82f6")+";\n  --context-menu-separator: "+(this.options.style.separator||"rgba(0, 0, 0, 0.08)")+";\n  --padding: "+(this.options.style.padding||"10px")+";\n  --padding-horizontal: "+(this.options.style.paddingHorizontal||"15px")+";\n  --gap: "+(this.options.style.gap||"10px")+";\n  --border-radius: "+(this.options.style.borderRadius||"8px")+";\n  --border-radius-input: "+(this.options.style.borderRadiusInput||"4px")+";\n  --font-size: "+(this.options.style.fontSize||"14px")+";\n  --transition: "+(this.options.style.transition||"0.2s")+" ease;\n  --transition-fast: "+(this.options.style.transitionFast||"0.1s")+" ease;\n  --transition-input: "+(this.options.style.transitionInput||"0.2s")+" ease;\n}\n\n.context-menu {\n  background: var(--context-menu-bg);\n  border: 1px solid var(--context-menu-border);\n  border-radius: var(--border-radius);\n  box-shadow: var(--context-menu-shadow);\n  padding: var(--padding) 0;\n  min-width: 220px;\n  z-index: 1000;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\n  color: var(--context-menu-text);\n  animation: contextMenuSlideIn var(--transition-fast) forwards;\n  transform-origin: top center;\n}\n\n.context-menu:has(> .context-menu-dropdown)::after {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 500%;\n    z-index: -1;\n}\n\n.context-menu-button,\n.context-menu-submenu {\n  display: flex;\n  align-items: center;\n  width: 100%;\n  padding: calc(var(--padding) + 2px) var(--padding-horizontal);\n  border: none;\n  background: none;\n  font-size: var(--font-size);\n  text-align: left;\n  cursor: pointer;\n  color: var(--context-menu-text);\n  transition: background-color var(--transition-fast), color var(--transition-fast);\n  position: relative;\n  gap: var(--gap);\n}\n\n.context-menu-button:disabled {\n  color: rgba(26, 26, 26, 0.4);\n  cursor: not-allowed;\n}\n\n.context-menu-button[data-marked=\"true\"] {\n  font-weight: bold;\n  background-color: var(--context-menu-accent);\n  color: white;\n  border-radius: calc(var(--border-radius) / 2);\n  border: 1px solid var(--context-menu-accent);\n}\n\n.context-menu-button[data-marked=\"true\"]:hover {\n  background-color: var(--context-menu-accent);\n  color: white;\n}\n\n.context-menu-button span,\n.context-menu-submenu span {\n  display: flex;\n  align-items: center;\n  pointer-events: none;\n}\n\n.context-menu-button:hover,\n.context-menu-submenu:hover {\n  background-color: var(--context-menu-hover-bg);\n}\n\n.context-menu-button:focus,\n.context-menu-submenu:focus {\n  outline: none;\n  background-color: var(--context-menu-hover-bg);\n}\n\n.context-menu-separator {\n  height: 1px;\n  background-color: var(--context-menu-separator);\n  margin: var(--padding) 0;\n}\n\n.context-menu-input {\n  padding: var(--padding) var(--padding-horizontal);\n}\n\n.context-menu-input input {\n  width: calc(100% - var(--padding-horizontal));\n  padding: var(--padding);\n  border: 1px solid var(--context-menu-border);\n  border-radius: var(--border-radius-input);\n  font-size: var(--font-size);\n  background-color: #f9fafb;\n  transition: border-color var(--transition-input), box-shadow var(--transition-input);\n}\n\n.context-menu-input input:focus {\n  outline: none;\n  border-color: var(--context-menu-accent);\n  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);\n}\n\n.context-menu-dropdown {\n  width: calc(100% - calc(var(--padding-horizontal) * 2));\n  margin: var(--padding) var(--padding-horizontal);\n  padding: var(--padding);\n  border: 1px solid var(--context-menu-border);\n  border-radius: var(--border-radius-input);\n  font-size: var(--font-size);\n  background-color: #f9fafb;\n  transition: border-color var(--transition-input), box-shadow var(--transition-input);\n}\n\n.context-menu-checkbox,\n.context-menu-radio {\n  display: flex;\n  align-items: center;\n  padding: calc(var(--padding) + 2px) var(--padding-horizontal);\n  font-size: var(--font-size);\n  cursor: pointer;\n  transition: background-color var(--transition-fast);\n}\n\n.context-menu-checkbox:hover,\n.context-menu-radio:hover {\n  background-color: var(--context-menu-hover-bg);\n}\n\n.context-menu-checkbox input,\n.context-menu-radio input {\n  margin-right: var(--gap);\n  accent-color: var(--context-menu-accent);\n}\n\n.context-menu-checkbox input:focus,\n.context-menu-radio input:focus {\n  outline: none;\n  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);\n}\n\n.context-menu-checkbox input:checked,\n.context-menu-radio input:checked {\n  background-color: var(--context-menu-accent);\n}\n\n.context-menu-search-select {\n  display: flex;\n  flex-direction: column;\n  padding: calc(var(--padding) + 2px) var(--padding-horizontal);\n}\n\n.context-menu-search-select input {\n  padding: var(--padding);\n  border: 1px solid var(--context-menu-border);\n  border-radius: var(--border-radius-input);\n  font-size: var(--font-size);\n  background-color: #f9fafb;\n  transition: border-color var(--transition-input), box-shadow var(--transition-input);\n}\n\n.context-menu-search-select input:focus {\n  outline: none;\n  border-color: var(--context-menu-accent);\n  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);\n}\n\n.context-menu-search-select-list {\n  max-height: 200px;\n  overflow-y: auto;\n  margin-top: var(--padding);\n}\n\n.context-menu-search-select-list button {\n    width: 100%;\n    padding: var(--padding);\n    background: #007BFF;\n    font-size: var(--font-size);\n    text-align: left;\n    cursor: pointer;\n    color: #ffffff;\n    transition: background-color var(--transition-fast), color var(--transition-fast);\n}\n\n.context-menu-search-select-list label {\n  display: flex;\n  flex-direction: row-reverse;\n  gap: var(--gap);\n  align-items: center;\n  padding: var(--padding) 0;\n  justify-content: flex-end;\n}\n\n.context-menu-search-select-list label:hover {\n  background-color: var(--context-menu-hover-bg);\n}\n\n.context-menu-search-select-list input {\n  margin-right: var(--gap);\n  accent-color: var(--context-menu-accent);\n}\n\n.context-menu-search-select-list input:focus {\n  outline: none;\n  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);\n}\n\n.context-menu-submenu {\n  position: relative;\n}\n\n/* Animation */\n@keyframes contextMenuSlideIn {\n  from {\n    opacity: 0;\n    transform: translateY(-10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(calc(-1 * var(--padding)));\n  }\n}\n\n/* Focus and Accessibility */\n.context-menu:focus {\n  outline: none;\n}\n\n.context-menu-button:focus-visible,\n.context-menu-submenu:focus-visible {\n  outline: 2px solid var(--context-menu-accent);\n  outline-offset: -2px;\n}\n",document.head.appendChild(e)}}
//# sourceMappingURL=DynamicGrid.min.js.map